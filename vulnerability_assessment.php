<?php
/**
 * SRM-Audit - Vulnerability Assessment Page (Module 4)
 * OWASP-based vulnerability identification with checkbox selection,
 * auto risk mapping, and connection to findings.
 */
session_start();
require_once 'functions/db.php';
require_once 'functions/auth.php';
require_once 'functions/owasp_library.php';

requireLogin();
requireAuditor(); // Only admin/auditor can run assessments

$userId = $_SESSION['user_id'];
$audit_id = intval($_GET['audit_id'] ?? ($_SESSION['active_audit_id'] ?? 0));
$selectedOrgId = intval($_GET['org_id'] ?? 0);
$pageError = '';

// Get organizations for switcher
$stmtOrgList = $pdo->prepare("SELECT id, organization_name FROM organizations WHERE user_id = ? AND is_active = 1 ORDER BY organization_name ASC");
$stmtOrgList->execute([$userId]);
$organizations = $stmtOrgList->fetchAll(PDO::FETCH_ASSOC);

// Get all audit sessions for switcher
$stmtAuditList = $pdo->prepare("
    SELECT a.id, a.organization_id, a.session_name, a.audit_date, o.organization_name 
    FROM audit_sessions a 
    JOIN organizations o ON a.organization_id = o.id 
    WHERE o.user_id = ? 
    ORDER BY a.audit_date DESC, a.created_at DESC
");
$stmtAuditList->execute([$userId]);
$allAudits = $stmtAuditList->fetchAll(PDO::FETCH_ASSOC);

// Verify audit access
if ($audit_id > 0) {
    $stmtAccess = $pdo->prepare("
        SELECT a.id, a.organization_id 
        FROM audit_sessions a 
        JOIN organizations o ON a.organization_id = o.id 
        WHERE a.id = ? AND o.user_id = ?
    ");
    $stmtAccess->execute([$audit_id, $userId]);
    $access = $stmtAccess->fetch(PDO::FETCH_ASSOC);

    if (!$access) {
        $pageError = 'Audit not found or access denied.';
        $audit_id = 0;
        unset($_SESSION['active_audit_id']);
    } else {
        $selectedOrgId = intval($access['organization_id']);
        $_SESSION['active_audit_id'] = $audit_id;
    }
}

// Get assets for this audit
$assets = [];
if ($audit_id) {
    $stmt = $pdo->prepare("SELECT id, asset_name, asset_type, criticality_score, criticality_level FROM assets WHERE audit_id = ? ORDER BY asset_name");
    $stmt->execute([$audit_id]);
    $assets = $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// Get OWASP library grouped by category
$owaspGrouped = getOwaspLibraryGrouped();

// Get existing vulnerability findings for this audit
$existingFindings = [];
if ($audit_id) {
    $stmt = $pdo->prepare("
        SELECT f.id, f.asset_id, f.title, f.owasp_category, f.cwe_id, 
               f.likelihood, f.impact, f.risk_score, f.risk_level, 
               f.nist_function, f.audit_status, f.recommendation,
               a.asset_name
        FROM findings f
        JOIN assets a ON f.asset_id = a.id
        WHERE f.audit_id = ? AND f.owasp_category IS NOT NULL AND f.owasp_category != ''
        ORDER BY f.risk_score DESC
    ");
    $stmt->execute([$audit_id]);
    $existingFindings = $stmt->fetchAll(PDO::FETCH_ASSOC);
}

include 'includes/header.php';
include 'includes/sidebar.php';
?>

<style>
    .vuln-category { 
        background: #f8f9fa; 
        border-left: 4px solid #0d6efd; 
        padding: 10px 15px; 
        margin-bottom: 5px;
        font-weight: 600;
    }
    .vuln-item {
        padding: 10px 15px 10px 30px;
        border-bottom: 1px solid #eee;
        transition: background 0.15s;
    }
    .vuln-item:hover { background: #f0f7ff; }
    .vuln-item label { cursor: pointer; }
    .vuln-meta { font-size: 0.82rem; color: #666; margin-top: 4px; }
    .risk-badge-critical { background: #dc3545; color: #fff; }
    .risk-badge-high { background: #fd7e14; color: #fff; }
    .risk-badge-medium { background: #ffc107; color: #333; }
    .risk-badge-low { background: #28a745; color: #fff; }
    .vuln-checklist {
        background: #e8f5e9;
        border-left: 3px solid #28a745;
        padding: 6px 12px;
        margin-top: 6px;
        font-size: 0.82rem;
    }
    .selected-count { 
        font-size: 1.1rem; 
        font-weight: 600; 
    }
    .risk-matrix-mini {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 2px;
        max-width: 250px;
    }
    .risk-matrix-mini .cell {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        color: #fff;
        border-radius: 3px;
    }
    .assessment-result {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }
    .assessment-result .table { margin: 0; }
    .expand-btn { cursor: pointer; color: #0d6efd; }
    .expand-btn:hover { text-decoration: underline; }
</style>

<div class="container mt-4">

<h2 class="mb-2">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-shield-exclamation me-2" viewBox="0 0 16 16">
        <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067s-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
        <path d="M7.001 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0z"/>
    </svg>
    Vulnerability Assessment (OWASP)
</h2>
<p class="text-muted mb-4">Select an asset, then check the vulnerabilities detected or suspected. The system auto-assigns risk scores and creates findings.</p>

<!-- Audit Session Switcher -->
<div class="card shadow-sm mb-4">
<div class="card-body">
<h6 class="mb-3">Select Organization & Audit Session</h6>
<form id="vulnAuditSwitcher" class="row g-2">
    <div class="col-md-5">
        <select id="orgSelect" class="form-select">
            <option value="">All Organizations</option>
            <?php foreach ($organizations as $org): ?>
                <option value="<?= intval($org['id']) ?>" <?= $selectedOrgId === intval($org['id']) ? 'selected' : '' ?>>
                    <?= htmlspecialchars($org['organization_name']) ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>
    <div class="col-md-5">
        <select id="auditSelect" class="form-select">
            <option value="">Select Audit Session</option>
            <?php foreach ($allAudits as $auditItem): ?>
                <option value="<?= intval($auditItem['id']) ?>"
                        data-org-id="<?= intval($auditItem['organization_id']) ?>"
                        <?= $audit_id === intval($auditItem['id']) ? 'selected' : '' ?>>
                    <?= htmlspecialchars($auditItem['organization_name'] . ' — ' . $auditItem['session_name'] . ' (' . $auditItem['audit_date'] . ')') ?>
                </option>
            <?php endforeach; ?>
        </select>
    </div>
    <div class="col-md-2 d-grid">
        <button class="btn btn-primary" type="submit">Open</button>
    </div>
</form>
</div>
</div>

<?php if (!empty($pageError)): ?>
    <div class="alert alert-danger"><?= htmlspecialchars($pageError) ?></div>
<?php endif; ?>

<?php if (!$audit_id): ?>
    <div class="alert alert-warning">Select an audit session to start the vulnerability assessment.</div>
<?php elseif (empty($assets)): ?>
    <div class="alert alert-info">
        No assets registered yet. 
        <a href="asset_manage.php?audit_id=<?= $audit_id ?>" class="alert-link">Add assets first</a> before performing vulnerability assessment.
    </div>
<?php else: ?>

<!-- ===== STEP 1: Select Asset ===== -->
<div class="card shadow-sm mb-4">
<div class="card-body">
    <h5 class="mb-3">Step 1 — Select Asset to Assess</h5>
    <div class="row">
        <div class="col-md-8">
            <select id="assetSelect" class="form-select form-select-lg">
                <option value="">-- Choose an asset --</option>
                <?php foreach ($assets as $a): ?>
                    <option value="<?= intval($a['id']) ?>" 
                            data-type="<?= htmlspecialchars($a['asset_type'] ?? '') ?>"
                            data-criticality="<?= htmlspecialchars($a['criticality_score'] ?? '0') ?>"
                            data-level="<?= htmlspecialchars($a['criticality_level'] ?? 'Low') ?>">
                        <?= htmlspecialchars($a['asset_name']) ?> 
                        (<?= htmlspecialchars($a['asset_type'] ?? 'Unknown') ?> — Criticality: <?= htmlspecialchars($a['criticality_level'] ?? 'N/A') ?>)
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <div class="col-md-4">
            <div id="assetInfo" class="p-2 rounded bg-light text-center text-muted" style="min-height:46px; line-height:30px;">
                Select an asset
            </div>
        </div>
    </div>
</div>
</div>

<!-- ===== STEP 2: Select Vulnerabilities ===== -->
<div id="vulnSelectionPanel" class="card shadow-sm mb-4" style="display:none;">
<div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Step 2 — Select Vulnerabilities Detected or Suspected</h5>
        <div>
            <span class="selected-count text-primary" id="selectedCount">0</span> selected
            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="selectAllBtn">Select All</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllBtn">Clear All</button>
        </div>
    </div>

    <form id="vulnAssessForm">
        <input type="hidden" name="audit_id" value="<?= $audit_id ?>">
        <input type="hidden" name="asset_id" id="formAssetId" value="">
        <?= csrfTokenInput() ?>

        <?php foreach ($owaspGrouped as $category => $vulns): ?>
            <div class="vuln-category">
                <input type="checkbox" class="form-check-input me-2 category-toggle" data-category="<?= htmlspecialchars($category) ?>">
                <?= htmlspecialchars($category) ?>
                <span class="badge bg-secondary ms-1"><?= count($vulns) ?></span>
            </div>

            <?php foreach ($vulns as $vuln): ?>
                <div class="vuln-item" data-category="<?= htmlspecialchars($category) ?>">
                    <div class="form-check">
                        <input class="form-check-input vuln-checkbox" 
                               type="checkbox" 
                               name="vuln_ids[]" 
                               value="<?= $vuln['id'] ?>"
                               id="vuln_<?= $vuln['id'] ?>"
                               data-category="<?= htmlspecialchars($category) ?>"
                               data-likelihood="<?= $vuln['default_likelihood'] ?>"
                               data-impact="<?= $vuln['default_impact'] ?>"
                               data-risk="<?= $vuln['default_likelihood'] * $vuln['default_impact'] ?>"
                               data-nist="<?= htmlspecialchars($vuln['nist_function']) ?>"
                               data-name="<?= htmlspecialchars($vuln['name']) ?>">
                        <label class="form-check-label fw-semibold" for="vuln_<?= $vuln['id'] ?>">
                            <?= htmlspecialchars($vuln['name']) ?>
                            <span class="badge bg-info ms-1"><?= htmlspecialchars($vuln['cwe_id']) ?></span>
                        </label>
                    </div>
                    <div class="vuln-meta">
                        <?= htmlspecialchars($vuln['description']) ?>
                    </div>
                    <div class="vuln-meta mt-1">
                        <strong>Threat:</strong> <?= htmlspecialchars($vuln['threat']) ?>
                        &nbsp;|&nbsp;
                        <strong>NIST:</strong> <?= htmlspecialchars($vuln['nist_function']) ?>
                        &nbsp;|&nbsp;
                        <strong>Risk:</strong> 
                        <?php 
                            $r = $vuln['default_likelihood'] * $vuln['default_impact'];
                            $cls = $r >= 20 ? 'critical' : ($r >= 15 ? 'high' : ($r >= 10 ? 'medium' : 'low'));
                        ?>
                        <span class="badge risk-badge-<?= $cls ?>"><?= $r ?> (L:<?= $vuln['default_likelihood'] ?> × I:<?= $vuln['default_impact'] ?>)</span>
                    </div>
                    <div class="vuln-checklist">
                        <strong>Audit Check:</strong> <?= htmlspecialchars($vuln['audit_checklist']) ?>
                    </div>

                    <!-- Expandable: Override likelihood/impact -->
                    <details class="mt-1" style="font-size:0.85rem;">
                        <summary class="expand-btn">Adjust likelihood/impact</summary>
                        <div class="row mt-1 g-2">
                            <div class="col-6">
                                <label class="form-label mb-0">Likelihood (1-5)</label>
                                <input type="number" name="likelihood_<?= $vuln['id'] ?>" 
                                       class="form-control form-control-sm" 
                                       min="1" max="5" value="<?= $vuln['default_likelihood'] ?>">
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0">Impact (1-5)</label>
                                <input type="number" name="impact_<?= $vuln['id'] ?>" 
                                       class="form-control form-control-sm" 
                                       min="1" max="5" value="<?= $vuln['default_impact'] ?>">
                            </div>
                        </div>
                    </details>
                </div>
            <?php endforeach; ?>
        <?php endforeach; ?>

        <!-- Risk Preview Summary -->
        <div id="riskPreview" class="card bg-light mt-3" style="display:none;">
            <div class="card-body">
                <h6>Assessment Preview</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div>Total Selected: <strong id="previewCount">0</strong></div>
                        <div>Avg Risk Score: <strong id="previewAvgRisk">0</strong></div>
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex gap-2 flex-wrap" id="previewBadges"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-danger btn-lg" id="submitAssessBtn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-shield-check me-1" viewBox="0 0 16 16">
                    <path d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067s-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56"/>
                    <path d="M10.854 5.854a.5.5 0 0 0-.708-.708L7.5 7.793 6.354 6.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z"/>
                </svg>
                Run Assessment &amp; Create Findings
            </button>
            <a href="findings.php?audit_id=<?= $audit_id ?>" class="btn btn-outline-secondary btn-lg">View All Findings</a>
        </div>
    </form>
</div>
</div>

<!-- ===== Existing Assessment Results ===== -->
<div class="card shadow-sm mb-4">
<div class="card-body">
    <h5 class="mb-3">
        Assessment Results
        <span class="badge bg-secondary" id="resultCount"><?= count($existingFindings) ?></span>
    </h5>
    
    <?php if (count($existingFindings) > 0): ?>
    <div class="assessment-result">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Vulnerability</th>
                    <th>Asset</th>
                    <th>CWE</th>
                    <th>NIST</th>
                    <th style="width:70px">L</th>
                    <th style="width:70px">I</th>
                    <th>Risk</th>
                    <th>Status</th>
                    <th>Recommendation</th>
                    <th style="width:60px"></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($existingFindings as $ef): 
                    $riskCls = '';
                    if ($ef['risk_level'] === 'Critical') $riskCls = 'risk-badge-critical';
                    elseif ($ef['risk_level'] === 'High') $riskCls = 'risk-badge-high';
                    elseif ($ef['risk_level'] === 'Medium') $riskCls = 'risk-badge-medium';
                    else $riskCls = 'risk-badge-low';
                ?>
                <tr>
                    <td><strong><?= htmlspecialchars($ef['owasp_category']) ?></strong></td>
                    <td><?= htmlspecialchars($ef['asset_name']) ?></td>
                    <td><span class="badge bg-info"><?= htmlspecialchars($ef['cwe_id'] ?? '') ?></span></td>
                    <td><?= htmlspecialchars($ef['nist_function']) ?></td>
                    <td><?= $ef['likelihood'] ?></td>
                    <td><?= $ef['impact'] ?></td>
                    <td><span class="badge <?= $riskCls ?>"><?= $ef['risk_score'] ?> — <?= $ef['risk_level'] ?></span></td>
                    <td><?= htmlspecialchars($ef['audit_status']) ?></td>
                    <td style="font-size:0.82rem"><?= htmlspecialchars(mb_strimwidth($ef['recommendation'] ?? '', 0, 100, '...')) ?></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger remove-vuln-btn" 
                                data-finding-id="<?= intval($ef['id']) ?>"
                                title="Remove this vulnerability finding">
                            &times;
                        </button>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php else: ?>
        <p class="text-muted text-center py-3">No vulnerability assessments yet. Select an asset and run the assessment above.</p>
    <?php endif; ?>
</div>
</div>

<?php endif; // end if audit_id and assets ?>

</div><!-- /container -->

<script>
// ===== Audit Session Switcher =====
const orgSelect = document.getElementById('orgSelect');
const auditSelect = document.getElementById('auditSelect');

function filterAuditsByOrg() {
    const orgId = orgSelect.value;
    Array.from(auditSelect.options).forEach((opt, i) => {
        if (i === 0) return;
        opt.hidden = orgId !== '' && (opt.dataset.orgId || '') !== orgId;
    });
    if (auditSelect.selectedOptions.length && auditSelect.selectedOptions[0].hidden) {
        auditSelect.value = '';
    }
}
orgSelect.addEventListener('change', filterAuditsByOrg);
filterAuditsByOrg();

document.getElementById('vulnAuditSwitcher').addEventListener('submit', function(e) {
    e.preventDefault();
    const aid = auditSelect.value;
    const oid = orgSelect.value;
    if (aid) window.location.href = 'vulnerability_assessment.php?audit_id=' + aid;
    else if (oid) window.location.href = 'vulnerability_assessment.php?org_id=' + oid;
});

<?php if ($audit_id && !empty($assets)): ?>
// ===== Asset Selection =====
const assetSelect = document.getElementById('assetSelect');
const vulnPanel = document.getElementById('vulnSelectionPanel');
const assetInfo = document.getElementById('assetInfo');
const formAssetId = document.getElementById('formAssetId');

// Track already-assessed vulns per asset (loaded from PHP)
const existingAssessments = <?= json_encode(
    array_reduce($existingFindings, function($carry, $f) {
        $carry[$f['asset_id']][] = $f['owasp_category'];
        return $carry;
    }, [])
) ?>;

assetSelect.addEventListener('change', function() {
    const val = this.value;
    if (!val) {
        vulnPanel.style.display = 'none';
        assetInfo.innerHTML = '<span class="text-muted">Select an asset</span>';
        return;
    }

    formAssetId.value = val;
    vulnPanel.style.display = 'block';

    const opt = this.selectedOptions[0];
    const type = opt.dataset.type || 'Unknown';
    const level = opt.dataset.level || 'N/A';
    assetInfo.innerHTML = `<span class="badge bg-primary">${type}</span> Criticality: <strong>${level}</strong>`;

    // Mark already-assessed checkboxes
    const assessed = existingAssessments[val] || [];
    document.querySelectorAll('.vuln-checkbox').forEach(cb => {
        const name = cb.dataset.name;
        if (assessed.includes(name)) {
            cb.checked = true;
            cb.disabled = true;
            cb.closest('.vuln-item').style.opacity = '0.5';
            cb.closest('.vuln-item').title = 'Already assessed';
        } else {
            cb.checked = false;
            cb.disabled = false;
            cb.closest('.vuln-item').style.opacity = '1';
            cb.closest('.vuln-item').title = '';
        }
    });

    updateCategoryToggles();
    updateSelectionPreview();
});

// ===== Category Toggle (select/deselect all in category) =====
document.querySelectorAll('.category-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
        const cat = this.dataset.category;
        const checked = this.checked;
        document.querySelectorAll(`.vuln-checkbox[data-category="${cat}"]`).forEach(cb => {
            if (!cb.disabled) cb.checked = checked;
        });
        updateSelectionPreview();
    });
});

function updateCategoryToggles() {
    document.querySelectorAll('.category-toggle').forEach(toggle => {
        const cat = toggle.dataset.category;
        const checkboxes = document.querySelectorAll(`.vuln-checkbox[data-category="${cat}"]:not(:disabled)`);
        const checked = document.querySelectorAll(`.vuln-checkbox[data-category="${cat}"]:not(:disabled):checked`);
        toggle.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
        toggle.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
    });
}

// ===== Select All / Clear All =====
document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.vuln-checkbox:not(:disabled)').forEach(cb => cb.checked = true);
    updateCategoryToggles();
    updateSelectionPreview();
});
document.getElementById('clearAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.vuln-checkbox:not(:disabled)').forEach(cb => cb.checked = false);
    updateCategoryToggles();
    updateSelectionPreview();
});

// ===== Individual checkbox change =====
document.querySelectorAll('.vuln-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
        updateCategoryToggles();
        updateSelectionPreview();
    });
});

// ===== Selection Preview =====
function updateSelectionPreview() {
    const checked = document.querySelectorAll('.vuln-checkbox:checked:not(:disabled)');
    const count = checked.length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('submitAssessBtn').disabled = count === 0;

    const preview = document.getElementById('riskPreview');
    const previewCount = document.getElementById('previewCount');
    const previewAvgRisk = document.getElementById('previewAvgRisk');
    const previewBadges = document.getElementById('previewBadges');

    if (count === 0) {
        preview.style.display = 'none';
        return;
    }

    preview.style.display = 'block';
    previewCount.textContent = count;

    let totalRisk = 0;
    let badges = '';
    checked.forEach(cb => {
        const risk = parseInt(cb.dataset.risk);
        totalRisk += risk;
        let cls = risk >= 20 ? 'critical' : (risk >= 15 ? 'high' : (risk >= 10 ? 'medium' : 'low'));
        badges += `<span class="badge risk-badge-${cls}">${cb.dataset.name}: ${risk}</span>`;
    });

    previewAvgRisk.textContent = (totalRisk / count).toFixed(1);
    previewBadges.innerHTML = badges;
}

// ===== Submit Assessment =====
document.getElementById('vulnAssessForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const checked = document.querySelectorAll('.vuln-checkbox:checked:not(:disabled)');
    if (checked.length === 0) {
        alert('Please select at least one vulnerability.');
        return;
    }

    const btn = document.getElementById('submitAssessBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Assessing...';

    const formData = new FormData(this);

    fetch('api/vuln_actions.php?action=assess', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = 'Run Assessment & Create Findings';
        }
    })
    .catch(err => {
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.innerHTML = 'Run Assessment & Create Findings';
    });
});

// ===== Remove Vulnerability Finding =====
document.querySelectorAll('.remove-vuln-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('Remove this vulnerability finding?')) return;

        const findingId = this.dataset.findingId;
        fetch('api/vuln_actions.php?action=remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                finding_id: findingId,
                csrf_token: document.querySelector('input[name="csrf_token"]').value
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('Error: ' + data.message);
        })
        .catch(() => alert('Network error'));
    });
});

<?php endif; ?>
</script>

<?php 
if (file_exists('includes/chatbot.html')) {
    readfile('includes/chatbot.html');
}
?>

<?php include 'includes/footer.php'; ?>
